### CAP

一个分布式系统最多只能同时满足一致性（Consistency）、可用性（Availability）和分区容错性（Partition tolerance）这三项中的两项。

- 一致性指所有节点在同一时间的数据完全一致，可以分为强/弱一致性。

1. 强一致性

对于关系型数据库，要求更新过的数据能被后续的访问都能看到，这是强一致性。

2. 弱一致性：更新过的数据不一定能立刻被后续的访问看到。

另外，最终一致性是弱一致性的一种形式，表示在一段时间（*不固定时间*）后，节点间的数据会最终达到一致状态。

- 可用性

可用性指服务在正常响应时间内一直可用（例如可以正常地接受读写请求）。

- 分区容错性

分区容错性指分布式系统在遇到某节点或网络分区故障的时候，仍然能够对外提供满足一致性（CP without A）或可用性（AP without C）的服务。


### 一致性哈希

一致性哈希主要是为了解决在分布式的数据存储系统中，由于节点的增减而导致的数据大量迁移的问题。被广泛应用于分布式缓存，比如 memcached。

算法步骤如下：

1. 将每个节点（服务器）映射到 0 - 2^32-1 的哈希环上；
2. 对于需要存储的数据，将它们取哈希，並映射到 0 - 2^32-1 的哈希环上；
3. 在步骤 2 中的位置开始沿着哈希环进行顺时针查找，将该数据存储到查找到的第一个节点上。

![image](../img/consistent_hash.jpg)

当增加或减少节点时，需要迁移的数据只有该变更节点到其逆时针的上一个节点中的数据。这可能会导致雪崩问题。

> 如果每个节点在环上只有一个节点，那么可以想象，当某一节点从环中退出时，它原本所负责的任务将全部交由顺时针方向的下一个节点处理。例如，当 node0 退出时，它原本所负责的缓存将全部交给 node1 处理。这就意味着 node1 的访问压力会瞬间增大。设想一下，如果 node1 因为压力过大而崩溃，那么更大的压力又会向 node2 压过去，最终服务压力就像滚雪球一样越滚越大，最终导致雪崩。

- 平衡性

平衡性是指哈希的结果能够尽可能分布到所有的缓冲中去，这样可以使得所有的缓冲空间都得到利用。很多哈希算法都能够满足这一条件。**一致性哈希通过引进虚节点的方法解决平衡性和雪崩问题。**一个物理节点（服务器）会被映射到多个虚拟节点上，而这些虚拟节点会均匀地分布到哈希环上。

- 单调性

单调性是指哈希的结果应能够保证原有已分配的内容可以被映射到原有节点上，避免在节点增减过程中的数据迁移和不能命中。**一致性哈希就很好地解决了单调性的问题。**